import streamlit as st
import pandas as pd
import io

# Set page title and icon
st.set_page_config(
    page_title="ê²½ë¹„ì˜ˆì‚° Merge Tool",
    page_icon="ğŸ’¸"
)

# App title and description
st.title("ğŸ’¸ ê²½ë¹„ì˜ˆì‚° Merge Tool")
st.markdown("ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´, í•„ìš”í•œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì—¬ ìƒˆë¡œìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ ë“œë¦½ë‹ˆë‹¤.")

# Sidebar for multiple file upload and year input
st.sidebar.header("ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ")
# Allow multiple files to be uploaded
uploaded_files = st.sidebar.file_uploader(
    "ì—¬ê¸°ì— íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—¬ëŸ¬ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.", 
    type=["xls", "xlsx"],
    accept_multiple_files=True
)

# User input for the year
year_input = st.sidebar.text_input(
    "ë°ì´í„°ì˜ ë…„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2024)", 
    pd.Timestamp.now().year
)

if uploaded_files:
    # A list to store DataFrames from each file
    all_dfs = []

    # Process each uploaded file
    for uploaded_file in uploaded_files:
        st.subheader(f"'{uploaded_file.name}' íŒŒì¼ ì²˜ë¦¬ ì¤‘...")
        try:
            # Read the uploaded Excel file, skipping to the 6th row for the header
            df_original = pd.read_excel(uploaded_file, header=5)

            # Convert column names to string type before removing unnamed columns
            df_original.columns = df_original.columns.astype(str)
            # Remove unnamed columns generated by pandas
            df_original = df_original.loc[:, ~df_original.columns.str.contains('^Unnamed')]

            st.dataframe(df_original)

            # Sanity check: Ensure required columns exist
            required_cols = ["ë¹„ìš©ì„¼í„°ì½”ë“œ", "ê³„ì •ì½”ë“œ"]
            if not all(col in df_original.columns for col in required_cols):
                st.error("ì—…ë¡œë“œëœ íŒŒì¼ì— 'ë¹„ìš©ì„¼í„°ì½”ë“œ' ë˜ëŠ” 'ê³„ì •ì½”ë“œ' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.")
                continue  # Skip to the next file
            
            # Filter out rows where "ë¹„ìš©ì„¼í„°ì½”ë“œ" is "í•© ê³„"
            df_original = df_original[df_original['ë¹„ìš©ì„¼í„°ì½”ë“œ'] != 'í•© ê³„']

            # Find all columns that are either 'ì›”' or a number from 1 to 12
            month_cols = []
            for col in df_original.columns:
                try:
                    if 1 <= int(col) <= 12:
                        month_cols.append(col)
                except ValueError:
                    if "ì›”" in str(col):
                        month_cols.append(col)

            if not month_cols:
                st.error("ì—‘ì…€ íŒŒì¼ì—ì„œ ì›”ë³„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì›”ë³„ ë°ì´í„° ì»¬ëŸ¼ì˜ ì œëª©ì´ '1', '2' ë˜ëŠ” '1ì›”', '2ì›”' ë“±ê³¼ ê°™ì€ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.")
                continue  # Skip to the next file

            # Round the month columns to the nearest whole number and convert to integer
            # This handles the user's request to round the values "from the start".
            df_original[month_cols] = df_original[month_cols].round(0).astype(int)

            # Melt the DataFrame to long format
            df_melted = pd.melt(
                df_original,
                id_vars=["ë¹„ìš©ì„¼í„°ì½”ë“œ", "ê³„ì •ì½”ë“œ"],
                value_vars=month_cols,
                var_name="ì›”",
                value_name="ê³ ì •ë¹„ê¸ˆì•¡"
            )

            # Ensure the 'ì›”' column is treated as a string before using .str accessor
            df_melted['ì›”'] = df_melted['ì›”'].fillna('').astype(str)
            
            # Use a custom function to extract the month number safely
            def extract_month_number(month_string):
                try:
                    digits = ''.join(filter(str.isdigit, month_string))
                    return str(int(digits)).zfill(2)
                except (ValueError, TypeError):
                    return ''

            df_melted["ì›”_str"] = df_melted["ì›”"].apply(extract_month_number)

            # Drop rows where 'ê³ ì •ë¹„ê¸ˆì•¡' is NaN
            df_melted.dropna(subset=['ê³ ì •ë¹„ê¸ˆì•¡'], inplace=True)

            # Create the 'ê³„íšë…„ì›”' column in YYYYMM format
            if year_input:
                df_melted["ê³„íšë…„ì›”"] = str(year_input) + df_melted["ì›”_str"]
            else:
                st.warning("ë…„ë„ê°€ ì…ë ¥ë˜ì§€ ì•Šì•„ 'ê³„íšë…„ì›”' ì»¬ëŸ¼ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                df_melted["ê³„íšë…„ì›”"] = ""

            # Add required columns
            df_melted["ì°¨ëŒ€êµ¬ë¶„ì½”ë“œ"] = "1"
            df_melted["ì›ê°€ìš”ì†Œì½”ë“œ"] = df_melted["ê³„ì •ì½”ë“œ"]

            # Select and reorder the final columns
            df_final_file = df_melted[[
                "ê³„íšë…„ì›”",
                "ë¹„ìš©ì„¼í„°ì½”ë“œ",
                "ì°¨ëŒ€êµ¬ë¶„ì½”ë“œ",
                "ì›ê°€ìš”ì†Œì½”ë“œ",
                "ê³ ì •ë¹„ê¸ˆì•¡"
            ]]
            
            # Convert 'ì›ê°€ìš”ì†Œì½”ë“œ' to integer type
            try:
                df_final_file['ì›ê°€ìš”ì†Œì½”ë“œ'] = df_final_file['ì›ê°€ìš”ì†Œì½”ë“œ'].astype(float).astype(int)
            except ValueError:
                st.error(f"'{uploaded_file.name}' íŒŒì¼ì˜ 'ì›ê°€ìš”ì†Œì½”ë“œ'ì— ìˆ«ìê°€ ì•„ë‹Œ ê°’ì´ í¬í•¨ë˜ì–´ ìˆì–´ ì •ìˆ˜í˜•ìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                continue # Skip to the next file
            
            # Append the processed DataFrame to the list
            all_dfs.append(df_final_file)

        except Exception as e:
            st.error(f"'{uploaded_file.name}' íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
            st.info("íŒŒì¼ í˜•ì‹ì´ë‚˜ ë‚´ìš©ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.")

    # Concatenate all DataFrames in the list
    if all_dfs:
        df_combined = pd.concat(all_dfs, ignore_index=True)

        if not df_combined.empty:
            st.markdown("---")
            st.subheader("ìµœì¢… ë³‘í•©ëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
            st.dataframe(df_combined)

            # Create an in-memory Excel file for download
            buffer = io.BytesIO()
            df_combined.to_excel(buffer, index=False, engine="openpyxl")
            buffer.seek(0)

            # Download button for the new Excel file
            st.download_button(
                label="ê²°ê³¼ ë‹¤ìš´ë¡œë“œ",
                data=buffer,
                file_name="ê²½ë¹„ì˜ˆì‚°_ë³‘í•©_ê²°ê³¼.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                help="ë³€í™˜ëœ ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
            )
        else:
            st.markdown("---")
            st.info("ë³€í™˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—…ë¡œë“œí•œ íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.")

else:
    st.info("ì‹œì‘í•˜ë ¤ë©´ ì™¼ìª½ ì‚¬ì´ë“œë°”ì— ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.")
    st.markdown("---")
    st.markdown("""
    **ì‚¬ìš© ë°©ë²•:**
    1. ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ 'ì°¾ì•„ë³´ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”. ì—¬ëŸ¬ íŒŒì¼ì„ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    2. ë°ì´í„°ì— ë§ëŠ” ë…„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
    3. ì—…ë¡œë“œê°€ ì™„ë£Œë˜ë©´ ë³€í™˜ëœ ë°ì´í„°ì™€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
    """)
